// Prisma Schema for Apna Safar - Public Transport Navigation System
// Database: Supabase PostgreSQL with PostGIS extension

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Transport stop locations
model Stop {
  id        String                                @id @default(uuid())
  name      String
  line      String?
  latitude  Float
  longitude Float
  type      StopType
  isStation Boolean                               @default(false)
  // PostGIS geography point (lat/lng) for geospatial queries
  location  Unsupported("geography(Point,4326)")?
  createdAt DateTime                              @default(now())
  updatedAt DateTime                              @updatedAt

  // Relations
  routeStops         RouteStop[]
  transfersFrom      Transfer[]     @relation("FromStop")
  transfersTo        Transfer[]     @relation("ToStop")
  plannedRoutesStart PlannedRoute[] @relation("PlannedRouteStart")
  plannedRoutesEnd   PlannedRoute[] @relation("PlannedRouteEnd")

  @@index([latitude, longitude])
  @@index([type])
  @@map("stops")
}

// Transport routes (bus lines, metro lines, etc.)
model Route {
  id            String        @id @default(uuid())
  name          String
  line          String?
  transportType TransportType
  color         String? // Hex color for UI display
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  routeStops RouteStop[]
  fareRules  FareRule[]

  @@index([transportType])
  @@map("routes")
}

// Junction table: Routes and their stops in order
model RouteStop {
  id        String   @id @default(uuid())
  routeId   String
  stopId    String
  stopOrder Int // Order of stop in route (0, 1, 2, ...)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)
  stop  Stop  @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@unique([routeId, stopOrder])
  @@index([routeId])
  @@index([stopId])
  @@map("route_stops")
}

// Transfer points between stops (walking connections)
model Transfer {
  id               String   @id @default(uuid())
  fromStopId       String
  toStopId         String
  walkingDistanceM Float // Distance in meters
  estimatedTimeMin Int // Estimated walking time in minutes
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  fromStop Stop @relation("FromStop", fields: [fromStopId], references: [id], onDelete: Cascade)
  toStop   Stop @relation("ToStop", fields: [toStopId], references: [id], onDelete: Cascade)

  @@unique([fromStopId, toStopId])
  @@index([fromStopId])
  @@index([toStopId])
  @@map("transfers")
}

// Fare rules (for future pricing features)
model FareRule {
  id        String   @id @default(uuid())
  routeId   String
  baseFare  Float // Base fare in PKR
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
  @@map("fare_rules")
}

// Planned routes between stops (high-level summary for caching / history)
model PlannedRoute {
  id          String   @id @default(uuid())
  startStopId String
  endStopId   String
  // Array of route IDs used in this plan (ordered)
  routeIds    String[]
  etaMinutes  Int // Estimated time of arrival in minutes
  createdAt   DateTime @default(now())
  
  // User association
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Route completion tracking
  actualDurationMin Int? // Actual time taken (for analytics)
  completedAt DateTime? // When route was completed
  isSaved Boolean @default(false) // User saved this route
  savedName String? // User-given name for saved route
  
  // Route details (JSON stored as text, can be parsed)
  stepsJson String? // Serialized route steps
  preference String? // Route preference used (fastest, least-walking, least-transfers)
  walkingDistanceM Float? // Total walking distance
  transfersCount Int? // Number of transfers

  startStop Stop @relation("PlannedRouteStart", fields: [startStopId], references: [id])
  endStop   Stop @relation("PlannedRouteEnd", fields: [endStopId], references: [id])

  @@index([startStopId])
  @@index([endStopId])
  @@index([userId])
  @@index([completedAt])
  @@index([isSaved])
}

// User table for authentication and personalization
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  occupation   String?  // e.g., "student", "professional", "retired"
  // Supabase Auth handles password, so we store the auth user ID
  supabaseUserId String? @unique // Links to Supabase Auth users
  emailVerified Boolean  @default(false) // Email confirmation status
  resetPasswordToken String? // For password reset
  resetPasswordExpires DateTime? // Token expiry
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  plannedRoutes PlannedRoute[]
  apiUsage     UserApiUsage?
  reviews      Review[]

  @@map("users")
}

// API usage tracking for Google Maps API limits
model UserApiUsage {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Google Maps API usage counters
  dynamicMapsCount      Int      @default(0) // Maps JavaScript API
  placesAutocompleteCount Int    @default(0) // Places Autocomplete API
  directionsCount       Int      @default(0) // Directions/Routes API
  geocodingCount        Int      @default(0) // Geocoding API
  staticMapsCount      Int       @default(0) // Static Maps API (if used)
  
  // Monthly reset tracking
  lastResetAt           DateTime @default(now())
  resetMonth            Int      // 1-12, current month for reset tracking
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([resetMonth])
  @@map("user_api_usage")
}

// Reviews for services and user feedback
model Review {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Review content
  rating      Int      // 1-5 stars
  title       String?
  comment     String
  serviceType String?  // e.g., "AI Navigation", "Route Planning", "General"
  
  // Status
  isApproved  Boolean  @default(true) // For moderation
  isFeatured  Boolean  @default(false) // Featured reviews shown prominently
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isApproved])
  @@index([isFeatured])
  @@index([serviceType])
  @@map("reviews")
}

// Enums
enum StopType {
  BUS
  TRAIN
  METRO
  WALKING
  ORANGE_LINE  // Orange Line Metro
  FEEDER       // Feeder/Speedo Bus
}

enum TransportType {
  BUS
  TRAIN
  METRO
  ORANGE_LINE  // Orange Line Metro
  FEEDER       // Feeder/Speedo Bus
}
